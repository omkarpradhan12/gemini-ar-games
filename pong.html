<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Full-Court Pong</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Impact', sans-serif; }
        #input_video {
            position: absolute; width: 100vw; height: 100vh;
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        #gameCanvas { position: absolute; top: 0; left: 0; z-index: 2; }
        .ui {
            position: absolute; width: 100%; text-align: center; color: white;
            z-index: 3; pointer-events: none; text-shadow: 3px 3px 5px #000;
        }
        #score-board { top: 30px; font-size: 60px; display: flex; justify-content: space-around; letter-spacing: 5px; }
        #msg {
            top: 50%; transform: translateY(-50%); font-size: 40px;
            background: rgba(0,0,0,0.8); padding: 40px; display: none;
            pointer-events: auto; border: 4px solid #00d2d3;
        }
        button {
            padding: 20px 50px; font-size: 25px; cursor: pointer;
            background: #00d2d3; border: none; font-weight: bold; border-radius: 5px;
        }
    </style>
</head>
<body>

    <video id="input_video"></video>
    <canvas id="gameCanvas"></canvas>

    <div class="ui" id="score-board">
        <div id="p1-score" style="color: #00d2d3;">0</div>
        <div id="p2-score" style="color: #ff4757;">0</div>
    </div>

    <div class="ui" id="msg">
        <h1 id="winner-text">FREEDOM MODE</h1>
        <button onclick="startGame()">START MATCH</button>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('gameCanvas');
        const canvasCtx = canvasElement.getContext('2d');

        let isPlaying = false;
        let p1Score = 0, p2Score = 0;

        const INITIAL_SPEED = 14;
        const SPEED_INCREMENT = 1.05;
        const ball = { x: 0, y: 0, dx: 0, dy: 0, radius: 18 };
        const paddle = { width: 25, height: 160 };

        // Paddle position tracking
        let p1 = { x: 0, y: 300 };
        let p2 = { x: 0, y: 300 };

        function resize() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            p2.x = canvasElement.width - paddle.width; // Default P2 position
            if(!isPlaying) resetBall();
        }

        function resetBall() {
            ball.x = canvasElement.width / 2;
            ball.y = canvasElement.height / 2;
            const angle = (Math.random() * Math.PI / 2) - Math.PI / 4;
            const direction = Math.random() > 0.5 ? 1 : -1;
            ball.dx = Math.cos(angle) * INITIAL_SPEED * direction;
            ball.dy = Math.sin(angle) * INITIAL_SPEED;
        }

        function startGame() {
            p1Score = 0; p2Score = 0;
            updateScore();
            document.getElementById('msg').style.display = 'none';
            resetBall();
            isPlaying = true;
        }

        window.addEventListener('resize', resize);
        resize();

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // Center Line
            canvasCtx.setLineDash([15, 15]);
            canvasCtx.strokeStyle = 'rgba(255,255,255,0.4)';
            canvasCtx.lineWidth = 4;
            canvasCtx.beginPath();
            canvasCtx.moveTo(canvasElement.width/2, 0);
            canvasCtx.lineTo(canvasElement.width/2, canvasElement.height);
            canvasCtx.stroke();

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const hX = (1 - landmarks[9].x) * canvasElement.width; // Reversed for mirrored video
                    const hY = landmarks[9].y * canvasElement.height;
                    const center = canvasElement.width / 2;

                    // P1 logic (Left Side) - Allowed to move from 0 to Center
                    if (hX < center) {
                        p1.x = hX - paddle.width/2;
                        p1.y = hY - paddle.height/2;
                    }
                    // P2 logic (Right Side) - Allowed to move from Center to End
                    else {
                        p2.x = hX - paddle.width/2;
                        p2.y = hY - paddle.height/2;
                    }
                }
            }

            if (isPlaying) updateGame();
            drawGame();
        }

        function updateGame() {
            ball.x += ball.dx;
            ball.y += ball.dy;

            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvasElement.height) {
                ball.dy *= -1;
            }

            // P1 Collision Detection (Left Side Paddle)
            if (ball.dx < 0 &&
                ball.x - ball.radius < p1.x + paddle.width &&
                ball.x + ball.radius > p1.x &&
                ball.y > p1.y && ball.y < p1.y + paddle.height) {
                ball.dx = Math.abs(ball.dx) * SPEED_INCREMENT;
                let deltaY = ball.y - (p1.y + paddle.height/2);
                ball.dy += deltaY * 0.2;
            }

            // P2 Collision Detection (Right Side Paddle)
            if (ball.dx > 0 &&
                ball.x + ball.radius > p2.x &&
                ball.x - ball.radius < p2.x + paddle.width &&
                ball.y > p2.y && ball.y < p2.y + paddle.height) {
                ball.dx = -Math.abs(ball.dx) * SPEED_INCREMENT;
                let deltaY = ball.y - (p2.y + paddle.height/2);
                ball.dy += deltaY * 0.2;
            }

            // Scoring
            if (ball.x < 0) { p2Score++; updateScore(); resetBall(); }
            if (ball.x > canvasElement.width) { p1Score++; updateScore(); resetBall(); }
        }

        function drawGame() {
            // Glow effect for ball and paddles
            canvasCtx.shadowBlur = 20;

            canvasCtx.fillStyle = '#00d2d3';
            canvasCtx.shadowColor = '#00d2d3';
            canvasCtx.fillRect(p1.x, p1.y, paddle.width, paddle.height);

            canvasCtx.fillStyle = '#ff4757';
            canvasCtx.shadowColor = '#ff4757';
            canvasCtx.fillRect(p2.x, p2.y, paddle.width, paddle.height);

            canvasCtx.beginPath();
            canvasCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            canvasCtx.fillStyle = '#ffff00';
            canvasCtx.shadowColor = '#ffff00';
            canvasCtx.fill();
            canvasCtx.shadowBlur = 0;
        }

        function updateScore() {
            document.getElementById('p1-score').innerText = p1Score;
            document.getElementById('p2-score').innerText = p2Score;
        }

        const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        }).start();

        document.getElementById('msg').style.display = 'block';
    </script>
</body>
</html>
